openapi: 3.0.3
info:
  title: XParse Pipeline API
  description: |
    æ–‡æ¡£è§£ææµæ°´çº¿æ¥å£ï¼Œæ”¯æŒæ–‡æ¡£è§£æï¼ˆParseï¼‰ã€æ–‡æœ¬åˆ†å—ï¼ˆChunkï¼‰å’Œå‘é‡åŒ–ï¼ˆEmbedï¼‰çš„ç»„åˆå¤„ç†ã€‚
    
    ## æµæ°´çº¿è§„åˆ™
    - **parse** èŠ‚ç‚¹æ˜¯å¿…éœ€çš„ï¼Œä¸”å¿…é¡»æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
    - **chunk** å’Œ **embed** èŠ‚ç‚¹æ˜¯å¯é€‰çš„
    - å¦‚æœåŒæ—¶ä½¿ç”¨ chunk å’Œ embedï¼Œchunk å¿…é¡»åœ¨ embed ä¹‹å‰
    - æ¯ç§ç±»å‹çš„èŠ‚ç‚¹æœ€å¤šåªèƒ½å‡ºç°ä¸€æ¬¡
    - stages æ•°ç»„é•¿åº¦å¿…é¡»åœ¨ 1-3 ä¹‹é—´
  version: 1.0.0
  contact:
    name: TextIn API Team

servers:
  - url: https://api.textin.com
    description: ç”Ÿäº§ç¯å¢ƒ

security:
  - AppIdAuth: []
    SecretCodeAuth: []

paths:
  /api/xparse/pipeline:
    post:
      summary: æ–‡æ¡£å¤„ç†æµæ°´çº¿
      description: |
        æ‰§è¡Œæ–‡æ¡£å¤„ç†æµæ°´çº¿ï¼Œå¯ä»¥ç»„åˆä½¿ç”¨ parseã€chunkã€embed ä¸‰ç§å¤„ç†é˜¶æ®µã€‚
      operationId: executePipeline
      tags:
        - XParse Pipeline
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - stages
              properties:
                file:
                  type: string
                  format: binary
                  description: éœ€è¦å¤„ç†çš„æ–‡æ¡£æ–‡ä»¶ï¼ˆæ”¯æŒ PDFã€å›¾ç‰‡ç­‰æ ¼å¼ï¼‰
                stages:
                  type: string
                  description: |
                    æµæ°´çº¿é…ç½®çš„ JSON å­—ç¬¦ä¸²ï¼Œå¿…é¡»æ˜¯ PipelineStage æ•°ç»„ã€‚
                    
                    æ³¨æ„ï¼šè™½ç„¶è¿™é‡Œæ˜¯ string ç±»å‹ï¼ˆå› ä¸º form-data é™åˆ¶ï¼‰ï¼Œä½†å†…å®¹å¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON æ•°ç»„å­—ç¬¦ä¸²ã€‚
                    
                    ç¤ºä¾‹ JSON é…ç½®ï¼š
                    ```json
                    [
                      {
                        "type": "parse",
                        "config": {
                          "provider": "textin"
                        }
                      },
                      {
                        "type": "chunk",
                        "config": {
                          "strategy": "basic",
                          "max_characters": 1024
                        }
                      }
                    ]
                    ```
                    
                    å®é™…ä½¿ç”¨æ—¶éœ€è¦åºåˆ—åŒ–æˆ JSON å­—ç¬¦ä¸²ã€‚
                  example: '[{"type":"parse","config":{"provider":"textin"}},{"type":"chunk","config":{"strategy":"basic","max_characters":1024}}}]'
            encoding:
              stages:
                contentType: application/json
      responses:
        '200':
          description: å¤„ç†æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PipelineResponse'
              examples:
                parseOnly:
                  summary: ä»…è§£æç¤ºä¾‹
                  value:
                    elements:
                      - element_id: "elem_001"
                        type: "text"
                        metadata:
                          filename: "example.pdf"
                          filetype: "application/pdf"
                          file_size: 102400
                        text: "è¿™æ˜¯è§£æå‡ºçš„æ–‡æœ¬å†…å®¹"
                    stats:
                      original_elements: 10
                      chunked_elements: 0
                      embedded_elements: 0
                      stages:
                        - type: "parse"
                          config:
                            provider: "textin"
                
                fullPipeline:
                  summary: å®Œæ•´æµæ°´çº¿ç¤ºä¾‹
                  value:
                    elements:
                      - element_id: "elem_001"
                        type: "text"
                        metadata:
                          filename: "example.pdf"
                          filetype: "application/pdf"
                          file_size: 102400
                          embedded: [0.1, 0.2, 0.3]
                          orig_elements: ["elem_source_001"]
                        text: "è¿™æ˜¯å¤„ç†åçš„æ–‡æœ¬å—"
                    stats:
                      original_elements: 10
                      chunked_elements: 15
                      embedded_elements: 15
                      stages:
                        - type: "parse"
                          config:
                            provider: "textin"
                        - type: "chunk"
                          config:
                            strategy: "basic"
                            max_characters: 1000
                        - type: "embed"
                          config:
                            provider: "qwen"
                            model_name: "text-embedding-v4"
        
        '400':
          description: è¯·æ±‚å‚æ•°é”™è¯¯
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingFile:
                  summary: ç¼ºå°‘æ–‡ä»¶
                  value:
                    code: 400
                    message: "file is required"
                
                invalidStages:
                  summary: stages æ ¼å¼é”™è¯¯
                  value:
                    code: 400
                    message: "parse stages failed: invalid JSON"
                
                stagesValidationError:
                  summary: stages éªŒè¯å¤±è´¥
                  value:
                    code: 400
                    message: "first stage must be parse, got: chunk"
        
        '401':
          description: é‰´æƒå¤±è´¥
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 401
                message: "unauthorized: invalid app-id or secret-code"
        
        '500':
          description: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                code: 500
                message: "internal server error: parse failed"

components:
  securitySchemes:
    AppIdAuth:
      type: apiKey
      in: header
      name: x-ti-app-id
      description: 'è¯·[ç™»å½•Textin](https://www.textin.com/console/dashboard/setting)åå‰å¾€ "å·¥ä½œå°-è´¦å·è®¾ç½®-å¼€å‘è€…ä¿¡æ¯" æŸ¥çœ‹ x-ti-app-id'
    SecretCodeAuth:
      type: apiKey
      in: header
      name: x-ti-secret-code
      description: 'è¯·[ç™»å½•Textin](https://www.textin.com/console/dashboard/setting)åå‰å¾€ "å·¥ä½œå°-è´¦å·è®¾ç½®-å¼€å‘è€…ä¿¡æ¯" æŸ¥çœ‹ x-ti-secret-code'


  schemas:
    PipelineResponse:
      type: object
      required:
        - elements
        - stats
      properties:
        elements:
          type: array
          description: å¤„ç†åçš„å…ƒç´ åˆ—è¡¨
          items:
            $ref: '#/components/schemas/Element'
        stats:
          $ref: '#/components/schemas/PipelineStats'
    
    Element:
      type: object
      required:
        - element_id
        - type
        - metadata
        - text
      properties:
        element_id:
          type: string
          description: å…ƒç´ å”¯ä¸€æ ‡è¯†ç¬¦
          example: "elem_001"
        type:
          type: string
          description: å…ƒç´ ç±»å‹ï¼ˆå¦‚ text, title, table ç­‰ï¼‰
          example: "text"
        metadata:
          $ref: '#/components/schemas/Metadata'
        text:
          type: string
          description: å…ƒç´ çš„æ–‡æœ¬å†…å®¹
          example: "è¿™æ˜¯æ–‡æ¡£ä¸­çš„ä¸€æ®µæ–‡æœ¬"
    
    Metadata:
      type: object
      required:
        - filename
      properties:
        record_id:
          type: string
          description: è®°å½• ID
          example: "record_001"
        parent_id:
          type: string
          description: çˆ¶å…ƒç´  ID
          example: "parent_001"
        filename:
          type: string
          description: æ–‡ä»¶å
          example: "example.pdf"
        filetype:
          type: string
          description: æ–‡ä»¶ç±»å‹
          example: "application/pdf"
        file_size:
          type: integer
          format: int64
          description: æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
          example: 102400
        embedded:
          type: array
          description: å‘é‡åŒ–åçš„åµŒå…¥å‘é‡ï¼ˆä»…åœ¨æ‰§è¡Œ embed stage åå­˜åœ¨ï¼‰
          items:
            type: number
            format: float
          example: [0.1, 0.2, 0.3, 0.4, 0.5]
        orig_elements:
          type: array
          description: åŸå§‹å…ƒç´  ID åˆ—è¡¨ï¼ˆä»…åœ¨ chunk æ—¶è®¾ç½® include_orig_elements ä¸º true æ—¶å­˜åœ¨ï¼‰
          items:
            type: string
          example: ["elem_001", "elem_002"]
    
    PipelineStats:
      type: object
      required:
        - original_elements
        - chunked_elements
        - embedded_elements
        - stages
      properties:
        original_elements:
          type: integer
          description: åŸå§‹è§£æçš„å…ƒç´ æ•°é‡ï¼ˆparse stage äº§ç”Ÿï¼‰
          example: 10
        chunked_elements:
          type: integer
          description: åˆ†å—åçš„å…ƒç´ æ•°é‡ï¼ˆchunk stage äº§ç”Ÿï¼Œå¦‚æœæ²¡æœ‰æ‰§è¡Œåˆ™ä¸º 0ï¼‰
          example: 15
        embedded_elements:
          type: integer
          description: å‘é‡åŒ–åçš„å…ƒç´ æ•°é‡ï¼ˆembed stage äº§ç”Ÿï¼Œå¦‚æœæ²¡æœ‰æ‰§è¡Œåˆ™ä¸º 0ï¼‰
          example: 15
        stages:
          type: array
          description: å®é™…æ‰§è¡Œçš„ stages é…ç½®
          items:
            $ref: '#/components/schemas/PipelineStage'
    
    PipelineStage:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          enum: [parse, chunk, embed]
          description: |
            å¤„ç†é˜¶æ®µç±»å‹ï¼š
            - parse: æ–‡æ¡£è§£æ
            - chunk: æ–‡æœ¬åˆ†å—
            - embed: å‘é‡åŒ–
          example: "parse"
        config:
          type: object
          description: |
            é˜¶æ®µé…ç½®ï¼Œæ ¹æ® type ä¸åŒæœ‰ä¸åŒçš„ç»“æ„ï¼š
            - type=parse: ParseConfig
            - type=chunk: ChunkConfig
            - type=embed: EmbedConfig
          oneOf:
            - $ref: '#/components/schemas/ParseConfig'
            - $ref: '#/components/schemas/ChunkConfig'
            - $ref: '#/components/schemas/EmbedConfig'
          example: {}
    
    ParseConfig:
      type: object
      required:
        - provider
      description: |
        æ”¯æŒçš„ Parser ä¾›åº”å•†ï¼š
        - textin: TextIn è‡ªç ”è§£æå¼•æ“
        - mineru: MinerU è§£æå¼•æ“
        - paddle: PaddleOCR è§£æå¼•æ“
      properties:
        provider:
          type: string
          enum: [textin, mineru, paddle]
          description: |
            Parser ä¾›åº”å•†ï¼š
            - textin: TextIn è‡ªç ”è§£æå¼•æ“
            - mineru: MinerU è§£æå¼•æ“
            - paddle: PaddleOCR è§£æå¼•æ“
          default: "textin"
          example: "textin"
    
    ChunkConfig:
      type: object
      properties:
        strategy:
          type: string
          enum: [basic, by_title, by_page]
          description: |
            åˆ†å—ç­–ç•¥ï¼š
            - basic: åŸºç¡€åˆ†å—ï¼ˆæŒ‰å­—ç¬¦æ•°åˆ‡åˆ†ï¼‰
            - by_title: æŒ‰æ ‡é¢˜åˆ‡åˆ†
            - by_page: æŒ‰é¡µé¢åˆ‡åˆ†
          default: "basic"
          example: "basic"
        include_orig_elements:
          type: boolean
          description: æ˜¯å¦åœ¨ metadata ä¸­åŒ…å«åŸå§‹å…ƒç´  ID
          default: false
          example: true
        new_after_n_chars:
          type: integer
          description: åœ¨å¤šå°‘å­—ç¬¦ååˆ›å»ºæ–°å—
          example: 800
        max_characters:
          type: integer
          description: æ¯ä¸ªå—çš„æœ€å¤§å­—ç¬¦æ•°
          default: 1000
          example: 1000
        overlap:
          type: integer
          description: ç›¸é‚»å—ä¹‹é—´çš„é‡å å­—ç¬¦æ•°
          example: 100
    
    EmbedConfig:
      type: object
      required:
        - provider
        - model_name
      properties:
        provider:
          type: string
          enum: [qwen, doubao]
          description: |
            Embedding ä¾›åº”å•†ï¼š
            - qwen: é˜¿é‡Œäº‘é€šä¹‰åƒé—®
            - doubao: å­—èŠ‚è·³åŠ¨è±†åŒ…
          default: "qwen"
          example: "qwen"
        model_name:
          type: string
          description: |
            æ¨¡å‹åç§°ï¼Œå¿…é¡»ä¸ provider åŒ¹é…ï¼š
            
            **Qwen æ”¯æŒçš„æ¨¡å‹ï¼š**
            - text-embedding-v3
            - text-embedding-v4
            
            **Doubao æ”¯æŒçš„æ¨¡å‹ï¼š**
            - doubao-embedding-large-text-250515
            - doubao-embedding-text-240715
          default: "text-embedding-v4"
          example: "text-embedding-v4"
          enum:
            - text-embedding-v3
            - text-embedding-v4
            - doubao-embedding-large-text-250515
            - doubao-embedding-text-240715
    
    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: integer
          description: é”™è¯¯ç 
          example: 400
        message:
          type: string
          description: é”™è¯¯ä¿¡æ¯
          example: "invalid request parameters"

tags:
  - name: XParse Pipeline
    description: |
      æ–‡æ¡£å¤„ç†æµæ°´çº¿æ¥å£
      
      ## åŠŸèƒ½ç‰¹æ€§
      - ğŸ”„ çµæ´»çš„æµæ°´çº¿é…ç½®ï¼šå¯è‡ªç”±ç»„åˆ parseã€chunkã€embed ä¸‰ç§å¤„ç†é˜¶æ®µ
      - ğŸ“„ å¤šæ ¼å¼æ”¯æŒï¼šæ”¯æŒ PDFã€å›¾ç‰‡ç­‰å¤šç§æ–‡æ¡£æ ¼å¼
      - ğŸ§© æ™ºèƒ½åˆ†å—ï¼šæ”¯æŒåŸºç¡€ã€æŒ‰æ ‡é¢˜ã€æŒ‰é¡µé¢ä¸‰ç§åˆ†å—ç­–ç•¥
      - ğŸ¤– å¤šæ¨¡å‹æ”¯æŒï¼šæ”¯æŒé€šä¹‰åƒé—®å’Œè±†åŒ…çš„å¤šç§ embedding æ¨¡å‹
      - ğŸ“Š å¤„ç†ç»Ÿè®¡ï¼šè¿”å›è¯¦ç»†çš„å¤„ç†ç»Ÿè®¡ä¿¡æ¯
      
      ## è®¡è´¹è¯´æ˜
      - æŒ‰ç…§ parse é˜¶æ®µå¤„ç†çš„é¡µæ•°è®¡è´¹
      - chunk å’Œ embed é˜¶æ®µä¸é¢å¤–æ”¶è´¹
      - è®¡è´¹ä¿¡æ¯é€šè¿‡ x-ti-app-id å’Œ x-ti-secret-code è¿›è¡Œå…³è”

